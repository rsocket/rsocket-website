<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.6">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-122364851-2"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-122364851-2",{})</script>
<link rel="stylesheet" href="https://docusaurus.io/style.css">
<link rel="stylesheet" href="https://css.link">
<script src="https://docusaurus.io/slash.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js" async></script><title data-react-helmet="true">File upload/download | RSocket</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://rsocket.io/guides/rsocket-py/tutorial/files"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:image" content="https://rsocket.io/img/social/rsocket-io-facebook-og.jpg"><meta data-react-helmet="true" name="twitter:image" content="https://rsocket.io/img/social/rsocket-io-twitter-card.jpg"><meta data-react-helmet="true" name="twitter:site" content="@rsocket"><meta data-react-helmet="true" property="og:title" content="File upload/download | RSocket"><meta data-react-helmet="true" name="description" content="In this section we will add very basic file upload/download functionality. All files will be stored in memory,"><meta data-react-helmet="true" property="og:description" content="In this section we will add very basic file upload/download functionality. All files will be stored in memory,"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.png"><link data-react-helmet="true" rel="canonical" href="https://rsocket.io/guides/rsocket-py/tutorial/files"><link data-react-helmet="true" rel="alternate" href="https://rsocket.io/guides/rsocket-py/tutorial/files" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://rsocket.io/guides/rsocket-py/tutorial/files" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.dd96a8b4.css">
<link rel="preload" href="/assets/js/runtime~main.d9545ed9.js" as="script">
<link rel="preload" href="/assets/js/main.6c9ad0b4.js" as="script">
</head>
<body>
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="https://rsocket.io/img/r-socket-pink.svg" alt="RSocket" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="https://rsocket.io/img/r-socket-pink.svg" alt="RSocket" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">RSocket</b></a><a class="navbar__item navbar__link" href="/about/faq">About</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/guides">Guides</a><a href="https://github.com/rsocket" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><a class="navbar__item navbar__link" href="/help">Help</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button class="clean-btn backToTopButton_35hR" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">About</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Guides</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/">Introduction</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">rsocket-js</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">rsocket-py</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py">Introduction</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/simple">Simple Quickstart</a></li><li class="theme-doc-sidebar-item-category menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Tutorial</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/tutorial">Preface</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/tutorial/base">Getting started</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/tutorial/request_routing">Request routing</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/tutorial/user_session">User session</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/tutorial/messages">Private messages</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/tutorial/channels">Channels</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/guides/rsocket-py/tutorial/files">File upload/download</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/tutorial/statistics">Statistics</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/tutorial/reactivex">Reactivex</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/tutorial/websocket">Websocket</a></li></ul></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Client</a></li><li class="theme-doc-sidebar-item-category menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Server</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/rxpy">RxPy integration</a></li><li class="theme-doc-sidebar-item-link menu__list-item"><a class="menu__link" tabindex="0" href="/guides/rsocket-py/cli">Command Line Interface</a></li></ul></li></ul></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>File upload/download</h1></header><p>In this section we will add very basic file upload/download functionality. All files will be stored in memory,
and downloadable by all users.</p><p>See resulting code on <a href="https://github.com/rsocket/rsocket-py/tree/master/examples/tutorial/step5" target="_blank" rel="noopener noreferrer">GitHub</a></p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="shared"></a>Shared<a class="hash-link" href="#shared" title="Direct link to heading">#</a></h2><p>First, define a mimetype which will represent file names in the payloads. This will be used by both server and client, so
place it in the <b>shared</b> module:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly py"><pre tabindex="0" class="prism-code language-py codeBlock_23N8 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#9CDCFE"><span class="token plain">chat_filename_mimetype </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">b&#x27;chat/file-name&#x27;</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="server-side"></a>Server side<a class="hash-link" href="#server-side" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="data-classes"></a>Data-classes<a class="hash-link" href="#data-classes" title="Direct link to heading">#</a></h3><p>Next, we need a place to store the files in memory. Add a dictionary to the <code>ChatData</code> class to store the files.
The keys will be the file names, and the values the file content.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly py"><pre tabindex="0" class="prism-code language-py codeBlock_23N8 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> dataclasses </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> dataclass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> field</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Dict</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@dataclass</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">frozen</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token boolean">True</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">ChatData</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> field</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">default_factory</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token builtin" style="color:rgb(86, 156, 214)">dict</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="helper-methods"></a>Helper methods<a class="hash-link" href="#helper-methods" title="Direct link to heading">#</a></h3><p>Next, define a helper method which extracts the filename from the upload/download payload:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly py"><pre tabindex="0" class="prism-code language-py codeBlock_23N8 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> shared </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> chat_filename_mimetype</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">extensions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">composite_metadata </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> CompositeMetadata</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">helpers </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> utf8_decode</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">get_file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">composite_metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> CompositeMetadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> utf8_decode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">composite_metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">find_by_mimetype</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chat_filename_mimetype</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>This helper uses the <code>find_by_mimetype</code> method of <code>CompositeMetadata</code> to get a list of metadata items with the
specified mimetype.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="endpoints"></a>Endpoints<a class="hash-link" href="#endpoints" title="Direct link to heading">#</a></h3><p>Next, register the request-response endpoints for uploading and downloading files, and for retrieving a list of
available files:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly py"><pre tabindex="0" class="prism-code language-py codeBlock_23N8 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Awaitable</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> shared </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> chat_filename_mimetype</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">extensions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">composite_metadata </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> CompositeMetadata</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">extensions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">helpers </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> composite</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> metadata_item</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">frame_helpers </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ensure_bytes</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">helpers </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> create_response</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">payload </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Payload</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">routing</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">request_router </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> RequestRouter</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">streams</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">stream_from_generator </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> StreamFromGenerator</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">ChatUserSession</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">router_factory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        router </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> RequestRouter</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@router</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;file.upload&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">upload_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> composite_metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> CompositeMetadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> Awaitable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            chat_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">get_file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">composite_metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> create_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@router</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;file.download&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">download_file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">composite_metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> CompositeMetadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> Awaitable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">Payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            file_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> get_file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">composite_metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> create_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chat_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                                   composite</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">metadata_item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ensure_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> chat_filename_mimetype</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">@router</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token decorator annotation punctuation" style="color:rgb(212, 212, 212)">stream</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;files&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">get_file_names</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> Publisher</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            count </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chat_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            generator </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ensure_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> index </span><span class="token operator" style="color:rgb(212, 212, 212)">==</span><span class="token plain"> count</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">index</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">in</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                         </span><span class="token builtin" style="color:rgb(86, 156, 214)">enumerate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">chat_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">keys</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> StreamFromGenerator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">lambda</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> generator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>upload_file</code> and <code>download_file</code> methods (<em>Lines 18-27</em>) extract the filename from the metadata using the helper method we created,
and set and get the file content from the <code>chat_data</code> storage respectively.</p><p>In this section we introduce the second argument which can be passed to routed endpoints. If the session is set up to use
composite metadata, the <code>composite_metadata</code> parameter will contain a parsed structure of the metadata in the request payload.</p><p>Line 34 uses the <code>StreamFromGenerator</code> helper which creates a stream publisher from a generator factory.</p><p>The generator must return a tuple of two values for each iteration:</p><ul><li>Payload instance</li><li>boolean value denoting if it is the last element in the generator.
The argument for the helper class is a method which returns a generator, not the generator itself.</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="large-file-support"></a>Large file support<a class="hash-link" href="#large-file-support" title="Direct link to heading">#</a></h3><p>In the <code>download_file</code> method (Line 24), even though the frame size limit is 16MB, larger files can be downloaded.
To allow this, fragmentation must be enabled. This is done by adding the <code>fragment_size_bytes</code> argument to the <code>RSocketServer</code> instantiation:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly py"><pre tabindex="0" class="prism-code language-py codeBlock_23N8 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">rsocket_server </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> RSocketServer</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transports</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tcp </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> TransportTCP</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">session</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        RSocketServer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">TransportTCP</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">connection</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                      handler_factory</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">handler_factory</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                      fragment_size_bytes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">1_000_000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="client-side"></a>Client side<a class="hash-link" href="#client-side" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="methods"></a>Methods<a class="hash-link" href="#methods" title="Direct link to heading">#</a></h3><p>On the client side, we will add 3 methods to access the new server functionality:</p><ul><li><code>upload</code></li><li><code>download</code></li><li><code>list_files</code></li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly py"><pre tabindex="0" class="prism-code language-py codeBlock_23N8 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> List</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">awaitable</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">awaitable_rsocket </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> AwaitableRSocket</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">extensions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">helpers </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> composite</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> route</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> metadata_item</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">frame_helpers </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> ensure_bytes</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">helpers </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> utf8_decode</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">payload </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> Payload</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> shared </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> chat_filename_mimetype</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">class</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">ChatClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">upload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">request_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">content</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> composite</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            route</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;file.upload&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            metadata_item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ensure_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> chat_filename_mimetype</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">download</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">request_response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            metadata</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">composite</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                route</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;file.download&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                metadata_item</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ensure_bytes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> chat_filename_mimetype</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">list_files</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> List</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token builtin" style="color:rgb(86, 156, 214)">str</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        request </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> Payload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">metadata</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">composite</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">route</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;files&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        response </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> AwaitableRSocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">_rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">request_stream</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">request</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> </span><span class="token builtin" style="color:rgb(86, 156, 214)">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token builtin" style="color:rgb(86, 156, 214)">map</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">lambda</span><span class="token plain"> _</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> utf8_decode</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">_</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p><em>Lines 13-17</em> define the upload method. the <code>Payload</code> of the request-response consists of a body with the file&#x27;s contents,
and metadata which contains routing and the filename. To specify the filename a custom mimetype was used <strong>chat/file-name</strong>.
This mime type was used to create a metadata item using the <code>metadata_item</code> method. the <code>composite</code> method was used to combine
the two metadata items to the complete metadata of the payload.</p><p><em>Lines 19-24</em> define the download method. It is similar to the upload method, except for the absence of the payload data,
and a different route: &#x27;file.download&#x27;.</p><p><em>Lines 26-32</em> defines the list_files method. Same as the <code>list_channels</code> method in the previous section,
it uses the request-stream &#x27;files&#x27; endpoint to get a list of files.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="large-file-support-1"></a>Large file support<a class="hash-link" href="#large-file-support-1" title="Direct link to heading">#</a></h3><p>Same as on the server size, fragmentation must be enabled to allow uploading files larger than 16MB.
This is done by adding the <code>fragment_size_bytes</code> argument to the <code>RSocketClient</code> instantiation. Do this for both clients:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly py"><pre tabindex="0" class="prism-code language-py codeBlock_23N8 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">extensions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">mimetypes </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> WellKnownMimeTypes</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">helpers </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> single_transport_provider</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">rsocket_client </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> RSocketClient</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">from</span><span class="token plain"> rsocket</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">transports</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">tcp </span><span class="token keyword" style="color:rgb(86, 156, 214)">import</span><span class="token plain"> TransportTCP</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">with</span><span class="token plain"> RSocketClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">single_transport_provider</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">TransportTCP</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">connection1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                             metadata_encoding</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">WellKnownMimeTypes</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">MESSAGE_RSOCKET_COMPOSITE_METADATA</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                             fragment_size_bytes</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">1_000_000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">as</span><span class="token plain"> client1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We will try out the new functionality with the following code:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly py"><pre tabindex="0" class="prism-code language-py codeBlock_23N8 thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">async</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">def</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">files_example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">user1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> ChatClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> user2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> ChatClient</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    file_contents </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">b&#x27;abcdefg1234567&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    file_name </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;file_name_1.txt&#x27;</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> user1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">upload</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> file_contents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&#x27;Files: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation keyword" style="color:rgb(86, 156, 214)">await</span><span class="token string-interpolation interpolation"> user1</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">list_files</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    download </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">await</span><span class="token plain"> user2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">download</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">file_name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> download</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">data </span><span class="token operator" style="color:rgb(212, 212, 212)">!=</span><span class="token plain"> file_contents</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">raise</span><span class="token plain"> Exception</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;File download failed&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">print</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)">f&#x27;Downloaded file: </span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token string-interpolation interpolation builtin" style="color:rgb(86, 156, 214)">len</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-interpolation interpolation">download</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token string-interpolation interpolation">data</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token string-interpolation interpolation punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token string-interpolation string" style="color:rgb(206, 145, 120)"> bytes&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>call the <code>files_example</code> method from the main client method.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/rsocket/rsocket-website/edit/master/content-docs/guides/rsocket-py/tutorial/04-files.mdx" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_13-_"><span class="theme-last-updated">Last updated on <b><time datetime="2022-12-05T06:21:45.000Z">12/5/2022</time></b> by <b>jell-o-fishi</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/guides/rsocket-py/tutorial/channels"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Channels</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/guides/rsocket-py/tutorial/statistics"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Statistics Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#shared" class="table-of-contents__link">Shared</a></li><li><a href="#server-side" class="table-of-contents__link">Server side</a><ul><li><a href="#data-classes" class="table-of-contents__link">Data-classes</a></li><li><a href="#helper-methods" class="table-of-contents__link">Helper methods</a></li><li><a href="#endpoints" class="table-of-contents__link">Endpoints</a></li><li><a href="#large-file-support" class="table-of-contents__link">Large file support</a></li></ul></li><li><a href="#client-side" class="table-of-contents__link">Client side</a><ul><li><a href="#methods" class="table-of-contents__link">Methods</a></li><li><a href="#large-file-support-1" class="table-of-contents__link">Large file support</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/RSocketIO" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/img/r-socket-pink.svg" alt="RSocket Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/r-socket-pink.svg" alt="RSocket Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></div><div class="footer__copyright">Copyright Â© 2022 RSocket Contributors</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d9545ed9.js"></script>
<script src="/assets/js/main.6c9ad0b4.js"></script>
</body>
</html>